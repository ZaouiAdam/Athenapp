
@{
    ViewBag.Title = "Step settings";
}
<h2 style="margin-top:5%;">@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.Titre</h2><br />

<div class="row">
    <div class="col-lg-6">
        <div class="card card-default">
            <div class="card-header" style="background-color:grey;border-color:#CCCCCC;"> @ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.ChoixClient</div>
            <div class="card-body">
                @* Select Code CLient *@
                <div class="col-lg-1"></div>
                <div class="col-lg-10 form-group">
                    <p style="text-decoration: underline;">@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.CodeClient</p>
                    <select id="SelectCodeClient" class="form-control selectpicker" data-live-search="true" onchange="ListIncoterm(); AppendClient(); ListCodeAdresseClient();" style="width:100%;">
                        <option value="0">@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.SelectCodeClient</option>
                        @foreach (var item in ViewBag.Client)
                        {
                            string[] stringSeparators = new string[] { "ClientItem" };
                            var ArrayCodeClient = item.Value.Split(stringSeparators, StringSplitOptions.None);
                            <option value="@ArrayCodeClient[2]">@ArrayCodeClient[0] / @ArrayCodeClient[1]</option>
                        }
                    </select>
                    <div style="text-align:right;">
                        1/4
                    </div>
                </div>
                <div class="col-lg-12"></div>
                <br />
                @* Select Code Adresse CLient *@
                <div class="col-lg-1"></div>
                <div class="col-lg-10 form-group" id="BlockSelectCodeAdresseClient" style="visibility:hidden;display:none;">
                    <p style="text-decoration: underline;">@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.CodeAdresseClient</p>
                    <select id="SelectCodeAdresseClient" class="form-control" onchange="AppendClient(); ListNomClient();" style="width:100%;">
                        <option value="0">@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.SelectCodeAdresseClient</option>
                    </select>
                    <div style="text-align:right;">
                        2/4
                    </div>
                </div>
                <div class="col-lg-12"></div>
                <br />
                @* Select Adresse CLient *@
                <div class="col-lg-1"></div>
                <div class="col-lg-10 form-group" id="BlockSelectNomClient" style="visibility:hidden;display:none;">
                    <p style="text-decoration: underline;">@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.AdresseClient</p>
                    <div id="InputNomClient"></div>
                    <input type="hidden" id="SelectNomClient" value="0" />
                    <div style="text-align:right;">
                        3/4
                    </div>
                </div>
                <div class="col-lg-12"></div>
                <br />
                @* Select Incoterm *@
                <div class="col-lg-1"></div>
                <div class="col-lg-10 form-group" id="BlockSelectIncoterm" style="visibility:hidden;display:none;">
                    <p style="text-decoration: underline;">@ExpeditionHelper_SOL.Resources.Views.EtapeLecture.Index.IncotermSimple</p>
                    <select class="form-control" id="SelectIncoterm" onchange="ListStep(); AppendInsertStep();">
                        <option value="0">@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.SelectIncoterm</option>
                    </select>
                    <div style="text-align:right;">
                        4/4
                    </div>
                </div>
                <div class="col-lg-1"></div>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card card-default">
            <div class="card-header" style="background-color:grey;border-color:#CCCCCC;"> Filtre</div>
            <div class="card-body">
                @* Select Mode difficulté  *@

                <div class="col-lg-1"></div>
                <div class="col-lg-10 form-group">
                    <p style="text-decoration: underline;">@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.VueUtilisateur</p>
                    <div style="text-align:center;">
                        <label id="MaitriseBorder" style="border-radius:5px;">
                            <input type="checkbox" id="Maitrise" onchange="ListStep();" data-toggle="toggle" data-on="<i class='fa fa-star' aria-hidden='true'></i> @ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.Expert" data-off="<i class='fa fa-star-o' aria-hidden='true'></i> @ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.Novice">
                        </label>
                    </div>
                </div>
                <div class="col-lg-12"></div>
                <br />
            </div>
        </div>

        <div class="row">
            <div class="col-lg-12">
                <div class="card card-default">
                    <div class="card-header" style="background-color:grey;border-color:#CCCCCC;">@ExpeditionHelper_SOL.Resources.Views.EtapeDefaut.Index.Profil</div>
                    <div class="card-body">
                        <div class="col-lg-12 form-group">
                            <div id="BlockSelectGroup">
                                <div id="RemoveBlockAddGroup">
                                    <select class="form-control" id="SelectGroup" onchange="ListStep();">
                                        <option value="0">@ExpeditionHelper_SOL.Resources.Views.EtapeDefaut.Index.SelectItemTitle</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-12"></div>
                        <br />
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<br />
<br />

@* Affichage Etape *@
<div class="row">
    <div class="col-lg-10">
        <div class="card card-default">
            <div class="card-header" style="background-color:grey;border-color:#CCCCCC;">@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.TitreCard</div>
            <div class="card-body" style="text-align:center;">
                <table class="table table-hover" id="BlockTableEtape">
                    <tr>
                        <th style="text-align:center;">@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.Numero</th>
                        <th style="text-align:center;">@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.Explication</th>
                        <th style="text-align:center;">@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.Incoterm</th>
                        <th style="text-align:center;">@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.Action</th>
                    </tr>
                    <tbody id="TableEtape"></tbody>
                </table>
                <br />
                <div class="row" id="BlockInsertStep">
                </div>
            </div>
        </div>
    </div>
</div>
<div style="margin-bottom:250px;"></div>

@* Modal Lien *@
<div class="modal fade" id="ModalLink" role="dialog">
    <div class="modal-dialog modal-lg">
        <div style="margin-top:25%;"></div>
        <div class="modal-content" style="text-align:center;">
            <div class="modal-header" style="background-color:#337AB7;border-color:#0080CD;color:white;">
                <button type="button" class="close" data-dismiss="modal" style="color:red;">&times;</button>
                <h4 class="modal-title">@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.ModalLinkReadTitre</h4>
            </div>
            <div class="modal-body" style="text-align:center;">
                @* Contenu de a fonction ListLinkHelper *@
                <div id="TableBodyLink">

                </div>
            </div>
        </div>
    </div>
</div>

@* Modal Ajout Lien *@
<div class="modal fade" id="ModalAddLink" role="dialog">
    <div class="modal-dialog modal-lg">
        <div style="margin-top:25%;"></div>
        <div class="modal-content" style="text-align:center;">
            <div class="modal-header" style="background-color:#337AB7;border-color:#0080CD;color:white;">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.ModalLinkWriteTitre</h4>
            </div>
            <div class="modal-body" style="text-align:center;">
                @* Contenu de a fonction ListLinkHelper *@
                <div id="TableAddLink">

                </div>
            </div>
        </div>
    </div>
</div>


@* Modal Update *@
<div class="modal fade" id="ModalUpdateStep" role="dialog">
    <div class="modal-dialog modal-lg">
        <div style="margin-top:25%;"></div>
        <div class="modal-content" style="text-align:center;">
            <div class="modal-header" style="background-color:#337AB7;border-color:#0080CD;color:white;">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.ModalUpdateStepTitre</h4>
            </div>
            <div class="modal-body" id="BlockBodyUpdateStep" style="text-align:center;">
                @* Contenu de a fonction ListLinkHelper *@
            </div>
            <div class="modal-footer" style="text-align:center;">
                <button type="button" class="btn btn-warning" onclick="UpdateStep();" aria-hidden="true"> @ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.ModalUpdateStepBtnEditer</button>
            </div>
        </div>
    </div>
</div>

@* Modal Delete *@
<div class="modal fade" id="ModalDeleteStep" role="dialog">
    <div class="modal-dialog modal-lg">
        <div style="margin-top:25%;"></div>
        <div class="modal-content" style="text-align:center;">
            <div class="modal-header" style="background-color:#337AB7;border-color:#0080CD;color:white;">
                <button type="button" class="close" data-dismiss="modal" style="color:white;">&times;</button>
                <h4 class="modal-title">@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.ModalDeleteStepTitre</h4>
            </div>
            <div id="BlockBodyDeleteStep" style="text-align:center;">
                @* Contenu de a fonction ListLinkHelper *@
            </div>
        </div>
    </div>
</div>

<input type="hidden" id="GardenMaxStep" value="0" />
<input type="hidden" id="GardenMaxNom" value="0" />
<input type="hidden" id="GardenMaxCodeClient" value="0" />
<input type="hidden" id="GardenMaxStepDefaut" value="0" />
<input type="hidden" id="GardenIdStep" value="0" />
<input type="hidden" id="GardenIdStepTable" value="0" />

<script>
    // List
    $(document).ready(function () {
        ListGroup();
        ListStep();
        AppendInsertStep();
        ListIncoterm();
        UpdateOrderStep();
    });

    function decode(str) {
        var textArea = document.createElement('textarea');
        textArea.innerHTML = str;
        return textArea.value;
    }

    // Gestion du menu des client
    function AppendClient() {
        var CodeClient = document.getElementById("SelectCodeClient").value;
        var CodeAdresseClient = document.getElementById("SelectCodeAdresseClient").value;
        if (CodeClient == "0") {
            HideAdresseClient();
            HideNomClient();
            HideIncoterm();
        }
        if ((CodeClient == "0") || (CodeAdresseClient == "0")) {
            HideNomClient();
            HideIncoterm();
        }
        if (CodeClient != "0") {
            ShowAdresseClient()
        }
        if ((CodeClient != "0") && (CodeAdresseClient != "0")) {
            ShowNomClient();
            ShowIncoterm();
        }
    }

    function HideAdresseClient() {
        document.getElementById("BlockSelectCodeAdresseClient").style.visibility = "hidden";
        document.getElementById("BlockSelectCodeAdresseClient").style.display = "none";
        TruncateSelectCodeClient();
    }
    function HideNomClient() {
        document.getElementById("BlockSelectNomClient").style.visibility = "hidden";
        document.getElementById("BlockSelectNomClient").style.display = "none";
        document.getElementById("SelectNomClient").value = 0;

    }
    function HideIncoterm() {
        document.getElementById("BlockSelectIncoterm").style.visibility = "hidden";
        document.getElementById("BlockSelectIncoterm").style.display = "none";
        ListIncoterm();
    }
    function ShowAdresseClient() {
        document.getElementById("BlockSelectCodeAdresseClient").style.visibility = "visible";
        document.getElementById("BlockSelectCodeAdresseClient").style.display = "block";
    }
    function ShowNomClient() {
        document.getElementById("BlockSelectNomClient").style.visibility = "visible";
        document.getElementById("BlockSelectNomClient").style.display = "block";
    }
    function ShowIncoterm() {
        document.getElementById("BlockSelectIncoterm").style.visibility = "visible";
        document.getElementById("BlockSelectIncoterm").style.display = "block";
        ListIncoterm();
    }


    // Videge du select Code Adresse du client
    function TruncateSelectCodeClient() {
        var GardenMaxCodeClient = document.getElementById("GardenMaxCodeClient").value;
        for (var i = 1; i <= GardenMaxCodeClient; i++) {
            $('#NewCodeAdresseClient' + i).remove();
        }
    }

    // Vidage du select Nom du client
    function TruncateSelectNom() {
        var GardenMaxNom = document.getElementById("GardenMaxNom").value;
        for (var i = 1; i <= GardenMaxNom; i++) {
            $('#NewAdresseClient' + i).remove();
        }
    }


    // Drag and drop changement ordre Etape
    function UpdateOrderStep() {
        $("#TableEtape").sortable({
            update: function (event, ui) {
                var itemIds = "";
                var i = 0;
                $("#TableEtape").find(".taskSingleInline").each(function () {
                    var itemId = $(this).attr("data-taskid");
                    if (i == 0) {
                        itemIds = itemId;
                    } else {
                        itemIds = itemIds + "," + itemId;
                    }
                    i++;
                });
                var incotermvalue = document.getElementById("SelectIncoterm").value;
                var IdAdresse = document.getElementById("SelectNomClient").value;
                var Maitrise = document.getElementById("Maitrise").checked;

                $.ajax({
                    url: 'EtapeParametrage/UpdateOrderStep',
                    type: "POST",
                    data: { itemIds: itemIds, incotermvalue: incotermvalue, Maitrise: Maitrise, IdAdresse: IdAdresse },
                    success: successFunc,
                    error: errorFunc
                });
                function successFunc(data, status) {
                    if (data == "Success") {
                        $("body").overhang({
                            type: "Success",
                            message: decode("@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.UpdateOrderFunction"),
                        });
                    }
                    if (data == "EtapeErreurDefaut") {
                        $("body").overhang({
                            type: "Warn",
                            message: decode("@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.DefautErrorUpdateOrderFunction"),
                        });
                    }
                    if (data == "ErreurFiltreIncoterm") {
                        $("body").overhang({
                            type: "Warn",
                            message: decode("@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.ErreurFiltreIncoterm"),
                        });
                    }
                    if (data == "ErreurFiltreMaitrise") {
                        $("body").overhang({
                            type: "Warn",
                            message: decode("@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.ErreurFiltreMaitrise"),
                        });
                    }
                    if (data == "Error") {
                        $("body").overhang({
                            type: "Error",
                            message: decode("@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.ErrorFunction"),
                        });
                    }
                    ListStep();
                }
                function errorFunc() {
                    $("body").overhang({
                        type: "Error",
                        message: decode("@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.ErrorFunction"),
                    });
                }
            }
        });
    }

    // Liste Code Adresse Client
    function ListCodeAdresseClient() {
        var CodeAdresseClient = document.getElementById("SelectCodeClient").value;
        $.ajax({
            url: 'EtapeParametrage/ListCodeAdresseClient',
            type: "POST",
            data: { CodeAdresseClient: CodeAdresseClient },
            success: successFunc,
            error: errorFunc
        });

        function successFunc(data, status) {
            TruncateSelectCodeClient();
            TruncateSelectNom();
            var iNom = 0;
            $(data).each(function (Index, emp) {
                var ArrayCodeClientClient = emp.Value.split('SeparateurString');
                iNom++;
                if (CodeAdresseClient != "") {
                    $('#SelectCodeAdresseClient').append('<option value="' + ArrayCodeClientClient[1] + '" id="NewCodeAdresseClient' + iNom + '">' + ArrayCodeClientClient[1] + '</option>');
                }
            });
            document.getElementById("GardenMaxCodeClient").value = iNom;
            HideNomClient();
            HideIncoterm();
            ListStep();
        }

        function errorFunc() {
            $("body").overhang({
                type: "Error",
                message: decode("@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.ErrorFunction"),
            });
        }
    }

    // Liste Nom Client
    function ListNomClient() {
        var CodeClient = document.getElementById("SelectCodeClient").value;
        var CodeAdresseClient = document.getElementById("SelectCodeAdresseClient").value;
        $.ajax({
            url: 'EtapeParametrage/ListNomClient',
            type: "POST",
            data: { CodeClient: CodeClient, CodeAdresseClient: CodeAdresseClient },
            success: successFunc,
            error: errorFunc
        });

        function successFunc(data, status) {
            $('#NomAdresseClient').remove();

            TruncateSelectNom();
            var iNom = 0;
            $(data).each(function (Index, emp) {
                var ArrayNomClient = emp.Value.split('SeparateurString');
                iNom++;
                if (CodeClient != "") {
                    $('#InputNomClient').append('<label id="NomAdresseClient">' + ArrayNomClient[1] + '</label>');
                    document.getElementById("SelectNomClient").value = ArrayNomClient[0];
                }
            });
            document.getElementById("GardenMaxNom").value = iNom;
            ListGroup();
        }

        function errorFunc() {
            $("body").overhang({
                type: "Error",
                message: decode("@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.ErrorFunction"),
            });
        }
    }

    // List Group Select
    function ListGroup() {

        var IdAdresse = document.getElementById("SelectNomClient").value;

        $.ajax({
            url: 'EtapeParametrage/ListGroup',
            type: "POST",
            data: { IdAdresse: IdAdresse},
            success: successFunc,
            error: errorFunc
        });

        function successFunc(data, status) {
            $('#RemoveBlockAddGroup').remove();
            $('#BlockSelectGroup').append('<div id="RemoveBlockAddGroup"><select class="form-control" id="SelectGroup" onchange="ListStep();"><option value="0">@ExpeditionHelper_SOL.Resources.Views.EtapeDefaut.Index.PlaceholderSelectGroup</option></select></div>');
            var iNom = 0;
            $(data).each(function (Index, emp) {
                var ArrayGroup = emp.Value.split('SeparateurString');
                iNom++;
                if (ArrayGroup[2] == "1") {
                    $('#SelectGroup').append('<option value="' + ArrayGroup[0] + '" id="NewGroup' + iNom + '" selected>' + ArrayGroup[1] + '</option>');
                } else {
                    $('#SelectGroup').append('<option value="' + ArrayGroup[0] + '" id="NewGroup' + iNom + '">' + ArrayGroup[1] + '</option>');
                }
            });
            ListStep();
        }

        function errorFunc() {
            $("body").overhang({
                type: "Error",
                message: decode("@ExpeditionHelper_SOL.Resources.Views.EtapeDefaut.Index.ErrorFunction"),
            });
        }
    }

    // Liste Etape
    function ListStep() {

        var IdGroup = document.getElementById("SelectGroup").value;
        var IdClient = document.getElementById("SelectNomClient").value;
        var CodeClient = document.getElementById("SelectCodeClient").value;
        var Incoterm = document.getElementById("SelectIncoterm").value;
        var IdAdresse = document.getElementById("SelectNomClient").value;

        $.ajax({
            url: 'EtapeParametrage/ListStep',
            type: "POST",
            data: { IdClientSelected: IdClient, IncotermId: Incoterm, IdGroup: IdGroup, IdAdresse: IdAdresse },
            success: successFunc,
            error: errorFunc
        });

        function successFunc(data, status) {
            // Rechargement du tableau
            $('#TableEtape').remove();
            $('#BlockTableEtape').append('<tbody id="TableEtape"></tbody>');

            // Initialisation du Drag N' Drop
            UpdateOrderStep();

            // Si la selection du client est vide ou inachever
            if ((IdClient == 0) || (CodeClient == 0) || (Incoterm == 0)) {
                $('#TableEtape').append('<tr id="NoneStep"><td>#</td><td><label>@ExpeditionHelper_SOL.Resources.Views.EtapeLecture.Index.NoClient</label></td>' +
                    '<td><label>@ExpeditionHelper_SOL.Resources.Views.EtapeLecture.Index.None</label></td><td><label>@ExpeditionHelper_SOL.Resources.Views.EtapeLecture.Index.None</label></td></tr>');
            } else {
                var iStepCheck = 0;
                $(data).each(function (Index, emp) {
                    // Split des information des applications
                    var ArrayStep = emp.Value.split('EtapeValue');

                    // Si il s'agit d'une étape par défaut et que le filtre de maitrise est desactiver
                    if ((ArrayStep[4] == "1") && (document.getElementById("Maitrise").checked == false)) {
                        // Si l'étape contient un lien
                        if (ArrayStep[3]) {
                            iStepCheck++;
                            $('#TableEtape').append('<tr><td class="taskSingleInline" data-taskid="' + ArrayStep[2] + '">' + iStepCheck + '</td><td><label style="font-weight: normal;">' + ArrayStep[0] + '</label> ' +
                                        '<a href="#" onclick="ListLinkRead(' + ArrayStep[2] + ');" style="font-weight: bold;" data-toggle="modal" data-target="#ModalLink" data-backdrop="static" data-keyboard="false">@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.BtnDocument</a></td>' +
                                        '<td><label>' + ArrayStep[1] + '</label></td>' +
                                        '<td><label><i class="fa fa-exclamation-triangle"></i> Impossible</label></td></tr>');
                        } else {
                            iStepCheck++;
                            $('#TableEtape').append('<tr><td class="taskSingleInline" data-taskid="' + ArrayStep[2] + '">' + iStepCheck + '</td><td><label style="font-weight: normal;">' + ArrayStep[0] + '</label></td><td><label>' + ArrayStep[1] + '</label></td>' +
                                '<td><label><i class="fa fa-exclamation-triangle"></i> Impossible</label></td></tr>');
                        }
                    } else if (ArrayStep[4] == "0") {
                        // Si l'étape contient un lien
                        if (ArrayStep[3]) {
                            iStepCheck++;
                            $('#TableEtape').append('<tr><td class="taskSingleInline" data-taskid="' + ArrayStep[2] + '">' + iStepCheck + '</td><td><label style="font-weight: normal;">' + ArrayStep[0] + '</label> ' +
                                    '<a href="#" onclick="ListLinkRead(' + ArrayStep[2] + ');" style="font-weight: bold;" data-toggle="modal" data-target="#ModalLink" data-backdrop="static" data-keyboard="false">@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.BtnDocument</a></td>' +
                                    '<td><label>' + ArrayStep[1] + '</label></td><td>' +
                                    '<button class="btn btn-primary" data-toggle="modal" data-target="#ModalUpdateStep" data-backdrop="static" data-keyboard="false" onclick="UpdateStepModal(' + ArrayStep[2] + ');"><i class="fa fa-pencil"></i></button> ' +
                                    '<button class="btn btn-danger" data-toggle="modal" data-target="#ModalDeleteStep" data-backdrop="static" data-keyboard="false" onclick="DeleteStepModal(' + ArrayStep[2] + ');"><i class="fa fa-trash"></i></button> ' +
                                    '<button class="btn btn-info" data-toggle="modal" data-target="#ModalAddLink" data-backdrop="static" data-keyboard="false" onclick="ListLinkWrite(' + ArrayStep[2] + ');"><i class="fa fa-link"></i></button> ' +
                                    '</td></tr>');
                        } else {
                            iStepCheck++;
                            $('#TableEtape').append('<tr><td class="taskSingleInline" data-taskid="' + ArrayStep[2] + '">' + iStepCheck + '</td><td><label style="font-weight: normal;">' + ArrayStep[0] + '</label> ' +
                                '</td>' +
                                '<td><label>' + ArrayStep[1] + '</label></td><td>' +
                                '<button class="btn btn-primary" data-toggle="modal" data-target="#ModalUpdateStep" data-backdrop="static" data-keyboard="false" onclick="UpdateStepModal(' + ArrayStep[2] + ');"><i class="fa fa-pencil"></i></button> ' +
                                '<button class="btn btn-danger" data-toggle="modal" data-target="#ModalDeleteStep" data-backdrop="static" data-keyboard="false" onclick="DeleteStepModal(' + ArrayStep[2] + ');"><i class="fa fa-trash"></i></button> ' +
                                '<button class="btn btn-info" data-toggle="modal" data-target="#ModalAddLink" data-backdrop="static" data-keyboard="false" onclick="ListLinkWrite(' + ArrayStep[2] + ');"><i class="fa fa-link"></i></button> ' +
                                '</td></tr>');
                        }
                    }
                    if (ArrayStep[4] == "2") {
                        $('#TableEtape').append('<tr style="background-color:#BFBFBF;"><td class="taskSingleInline" data-taskid="' + ArrayStep[2] + '"></td><td><label style="text-decoration: underline;">' + ArrayStep[0] + '</label><td></td></td>' +
                            '<td>' +
                            '<button class="btn btn-primary" data-toggle="modal" data-target="#ModalUpdateStep" data-backdrop="static" data-keyboard="false" onclick="UpdateStepModal(' + ArrayStep[2] + ');"><i class="fa fa-pencil"></i></button> ' +
                            '<button class="btn btn-danger" data-toggle="modal" data-target="#ModalDeleteStep" data-backdrop="static" data-keyboard="false" onclick="DeleteStepModal(' + ArrayStep[2] + ');"><i class="fa fa-trash"></i></button> ' +
                            '</td>' +
                            '</tr>');
                    }
                });
            }
        }

        function errorFunc() {
            $("body").overhang({
                type: "Error",
                message: decode("@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.ErrorFunction"),
            });
        }
    }

    // Liste Incoterm
    function ListIncoterm() {
        $.ajax({
            url: 'EtapeParametrage/ListIncoterm',
            type: "POST",
            success: successFunc,
            error: errorFunc
        });

        function successFunc(data, status) {
            var iIncoterm = 0;
            $(data).each(function (Index, emp) {
                var ArrayIncoterm = emp.Value.split('SeparateurString');
                if (ArrayIncoterm[1] != "Defaut") {
                    iIncoterm++;
                    $('#NewIncoterm' + iIncoterm).remove();
                    $('#SelectIncoterm').append('<option value="' + ArrayIncoterm[0] + '" id="NewIncoterm' + iIncoterm + '">' + ArrayIncoterm[1] + ' / ' + ArrayIncoterm[2] + '</option>');
                }
            });
        }

        function errorFunc() {
            $("body").overhang({
                type: "Error",
                message: decode("@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.ErrorFunction"),
            });
        }
    }

    // Liste Mise à jour Etape
    function UpdateStepModal(UpdateId) {
        $.ajax({
            url: 'EtapeParametrage/ListStepUpdate',
            type: "POST",
            data: { UpdateId: UpdateId },
            success: successFunc,
            error: errorFunc
        });

        function successFunc(data, status) {
            $(data).each(function (Index, emp) {
                var ArrayIncoterm = emp.Value.split('SeparateurString');
                $('#BlockBodyUpdateStepOld').remove();
                $('#BlockBodyUpdateStep').append('<div id="BlockBodyUpdateStepOld"><input type="text" class="form-control" id="EditStepName" value="' + ArrayIncoterm[1] + '"/>' +
                    '<input type="hidden" id="EditStepId" value="' + ArrayIncoterm[0] + '"/><br />');
            });
        }

        function errorFunc() {
            $("body").overhang({
                type: "Error",
                message: decode("@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.ErrorFunction"),
            });
        }
    }

    // Mise à jour Etape
    function UpdateStep() {
        var UpdateName = document.getElementById("EditStepName").value;
        var UpdateId = document.getElementById("EditStepId").value;
        $.ajax({
            url: 'EtapeParametrage/UpdateStep',
            type: "POST",
            data: { UpdateId: UpdateId, UpdateName: UpdateName },
            success: successFunc,
            error: errorFunc
        });

        function successFunc(data, status) {
            $("body").overhang({
                type: "Success",
                message: decode("@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.UpdateStep"),
            });
            $('.modal').modal('hide').data('bs.modal', null);
            ListStep();
        }

        function errorFunc() {
            $("body").overhang({
                type: "Error",
                message: decode("@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.FailUpdateStep"),
            });
        }
    }

    // Liste Suppression Étape
    function DeleteStepModal(DeleteId) {
        $.ajax({
            url: 'EtapeParametrage/ListStepDelete',
            type: "POST",
            data: { DeleteId: DeleteId },
            success: successFunc,
            error: errorFunc
        });

        function successFunc(data, status) {
            $(data).each(function (Index, emp) {
                var ArrayStepDelete = emp.Value.split('InfoStep:');
                $('#BlockBodyUpdateStepOld').remove();
                $('#BlockBodyDeleteStep').append('<div id="BlockBodyUpdateStepOld"><div class="modal-body" style="text-align:center;"><label>@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.ModalDeleteTexte</label></div>' +
                    '<div class="modal-footer" style="text-align:center;"> <button class="btn btn-danger" onclick="DeleteStep(' + ArrayStepDelete[0] + ');"> ' +
                    '@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.ModalDeleteStepBtnDelete</button> </div>');
            });
        }

        function errorFunc() {
            $("body").overhang({
                type: "Error",
                message: decode("@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.FailUpdateStep"),
            });
        }
    }

    // Suppression Etape
    function DeleteStep(DeleteId) {
        $.ajax({
            url: 'EtapeParametrage/DeleteStep',
            type: "POST",
            data: { DeleteId: DeleteId },
            success: successFunc,
            error: errorFunc
        });

        function successFunc(data, status) {
            if (data == "Success") {
                $("body").overhang({
                    type: "Success",
                    message: decode("@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.DeleteFunction"),
                });
                $('.modal').modal('hide').data('bs.modal', null);
            } else {
                $("body").overhang({
                    type: "Error",
                    message: decode("@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.FailDeleteFunction"),
                });
            }
            ListStep();
        }

        function errorFunc() {
            $("body").overhang({
                type: "Error",
                message: decode("@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.ErrorFunction"),
            });
        }
    }

    // Ajout Liste Etape
    function AppendInsertStep() {
        var Incoterm = document.getElementById("SelectIncoterm").value;
        if (Incoterm != 0) {
            $('#InsertView').remove();
            $('#BlockInsertStep').append('<div id="InsertView"><div class="col-lg-1"></div><div class="col-lg-8"><input type="text" class="form-control" id="NouvelleEtapeText" placeholder="@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.TitreCard" /></div>' +
                '<div class="col-lg-3"><button class="btn btn-success" onclick="InsertStep();">@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.BtnAjouter</button></div></div>');
        } else {
            $('#InsertView').remove();
            $('#BlockInsertStep').append('<div id="InsertView"><div class="col-lg-1"></div><div class="col-lg-8">' +
                '<input type="text" class="form-control" id="NouvelleEtapeText" placeholder="@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.PlaceholderAddStepFake" disabled/></div>' +
                '<div class="col-lg-3"><button class="btn btn-success" disabled>@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.BtnAjouter</button></div></div>');
        }
    }

    // Ajout Etape
    function InsertStep() {

        var itemIds = "";
        var i = 0;
        $("#TableEtape").find(".taskSingleInline").each(function () {
            var itemId = $(this).attr("data-taskid");
            if (i == 0) {
                itemIds = itemId;
            } else {
                itemIds = itemIds + "," + itemId;
            }
            i++;
        });

        var Maitrise = 1;
        if (document.getElementById("Maitrise").checked == false) {
            Maitrise = 0;
        }

        var CodeClient = document.getElementById("SelectCodeClient").value;
        var IdAdresse = document.getElementById("SelectNomClient").value;
        var AdresseClient = document.getElementById("SelectCodeAdresseClient").value;
        var Incoterm = document.getElementById("SelectIncoterm").value;
        var NouvelleEtapeText = document.getElementById("NouvelleEtapeText").value;
        $.ajax({
            url: 'EtapeParametrage/InsertStep',
            type: "POST",
            data: { CodeClient: CodeClient, Incoterm: Incoterm, NouvelleEtapeText: NouvelleEtapeText, AdresseClient: AdresseClient, IdAdresse: IdAdresse, itemIds: itemIds, Maitrise: Maitrise },
            success: successFunc,
            error: errorFunc
        });

        function successFunc(data, status) {
            switch (data) {
                case 'Success':
                    $("body").overhang({
                        type: "Success",
                        message: decode("@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.AddStepFunction"),
                    });
                    document.getElementById("NouvelleEtapeText").style.border = "1px solid #CCCCCC";
                    document.getElementById("MaitriseBorder").style.border = "1px solid white";
                    document.getElementById("NouvelleEtapeText").value = "";
                    break;
                case 'Error':
                    $("body").overhang({
                        type: "Warn",
                        message: decode("@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.FailAddStepFunction"),
                    });
                    break;
                case 'ErrorTextEmpty':
                    $("body").overhang({
                        type: "Warn",
                        message: decode("@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.EmptyTexte"),
                    });
                    document.getElementById("NouvelleEtapeText").style.border = "1px solid red";
                    break;
                case 'ErrorFiltreEmpty':
                    $("body").overhang({
                        type: "Warn",
                        message: decode("@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.FiltreTexte"),
                    });
                    document.getElementById("MaitriseBorder").style.border = "1px solid red";
                    document.getElementById("MaitriseBorder").style.border.radius = "5px";
                    break;
            }
            ListStep();
        }

        function errorFunc() {
            $("body").overhang({
                type: "Error",
                message: decode("@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.ErrorFunction"),
            });
        }
    }

    // Liste Lien Lecture
    function ListLinkRead(StepId) {
        $.ajax({
            url: 'EtapeParametrage/ListLinkRead',
            type: "POST",
            data: { StepId: StepId },
            success: successFunc,
            error: errorFunc
        });

        function successFunc(data, status) {
            var ArrayStepLink = data.split('LienStringNom:');
            var iLink = 0;
            var donnees = [];
            $(ArrayStepLink).each(function (Index, ArrayLink) {
                var ArrayStepURL = ArrayStepLink[iLink].split('LienStringURL:');
                donnees[iLink] = [ArrayStepURL[0], ArrayStepURL[1], '<a href="' + ArrayStepURL[1] + '" target="_blank"><i class="fa fa-external-link"></i></a>'];
                iLink++;
            });
            $('#BlockBodyLink').remove();
            $('#BlockBodyLink_wrapper').remove();

            $('#TableBodyLink').append('<table id="BlockBodyLink" class="table table-striped table-bordered" width="100%">' +
                '<thead>' +
                '   <tr>' +
                '       <td><label> @ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.ModalLinkNom </label></td>' +
                '       <td><label> @ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.ModalLinkURL </label></td>' +
                '       <td><label> @ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.ModalLinkLien </label></td>' +
                '   </tr>' +
                '</thead>' +
                '<tbody id="trtable"></tbody>' +
                '</table>');

            $('#BlockBodyLink').DataTable({
                data: donnees
            });
        }

        function errorFunc() {
            $("body").overhang({
                type: "Error",
                message: decode("@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.ErrorFunction"),
            });
        }
    }

    // Ajout lien Ecriture
    function ListLinkWrite(StepId) {
        $.ajax({
            url: 'EtapeParametrage/ListLinkWrite',
            type: "POST",
            data: { StepId: StepId },
            success: successFunc,
            error: errorFunc
        });

        function successFunc(data, status) {
            var iLink = 0;
            var donnees = [];
            $(data).each(function (Index, emp) {
                var ArrayLink = emp.Value.split('LienStringUrl:');
                if (ArrayLink[3] == 0) {
                    donnees[iLink] = [ArrayLink[0], ArrayLink[1], '<button class="btn btn-info" onclick="AddLink(' + ArrayLink[2] + ')"> <i class="fa fa-plus"></i> </button>'];
                } else {
                    donnees[iLink] = [ArrayLink[0], ArrayLink[1], '<button class="btn btn-danger" onclick="RemoveLink(' + ArrayLink[2] + ')"> <i class="fa fa-times"></i> </button>'];
                }
                iLink++;
            });
            document.getElementById("GardenIdStep").value = StepId;

            $('#BlockAddLink').remove();
            $('#BlockAddLink_wrapper').remove();

            $('#TableAddLink').append('<table id="BlockAddLink" class="table table-striped table-bordered" width="100%">' +
                '<thead>' +
                '   <tr>' +
                '       <td><label> @ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.ModalLinkNom </label></td>' +
                '       <td><label> @ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.ModalLinkURL </label></td>' +
                '       <td><label> @ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.Action </label></td>' +
                '   </tr>' +
                '</thead>' +
                '<tbody id="trtable"></tbody>' +
                '</table>');

            $('#BlockAddLink').DataTable({
                data: donnees
            });
        }

        function errorFunc() {
            $("body").overhang({
                type: "Error",
                message: decode("@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.ErrorFunction"),
            });
        }
    }

    // Ajout lien
    function AddLink(LinkId) {
        var StepIdModal = document.getElementById("GardenIdStep").value;
        $.ajax({
            url: 'EtapeParametrage/AddLink',
            type: "POST",
            data: { LinkId: LinkId, StepIdModal: StepIdModal },
            success: successFunc,
            error: errorFunc
        });

        function successFunc(data, status) {
            switch (data) {
                case 'Success':
                    $("body").overhang({
                        type: "Success",
                        message: decode("@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.AddLinkFunction"),
                    });
                    break;
                case 'Error':
                    $("body").overhang({
                        type: "Error",
                        message: decode("@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.FailAddLinkFunction"),
                    });
                    break;
            }
            ListStep();
            ListLinkWrite(StepIdModal);
        }

        function errorFunc() {
            $("body").overhang({
                type: "Error",
                message: decode("@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.ErrorFunction"),
            });
        }
    }

    // Suppression lien
    function RemoveLink(LinkId) {
        var StepIdModal = document.getElementById("GardenIdStep").value;
        $.ajax({
            url: 'EtapeParametrage/RemoveLink',
            type: "POST",
            data: { LinkId: LinkId, StepIdModal: StepIdModal },
            success: successFunc,
            error: errorFunc
        });

        function successFunc(data, status) {
            switch (data) {
                case 'Success':
                    $("body").overhang({
                        type: "Success",
                        message: decode("@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.DeleteLinkFunction"),
                    });
                    break;
                case 'Error':
                    $("body").overhang({
                        type: "Error",
                        message: decode("@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.FailDeleteLinkFunction"),
                    });
                    break;
            }
            ListStep();
            ListLinkWrite(StepIdModal);
        }

        function errorFunc() {
            $("body").overhang({
                type: "Error",
                message: decode("@ExpeditionHelper_SOL.Resources.Views.EtapeParametrage.Index.ErrorFunction"),
            });
        }
    }

</script>